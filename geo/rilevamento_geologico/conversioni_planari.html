<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bussola Geologica Interattiva</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        #compassCanvas {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
        }
        /* Stile specifico per il nuovo campo Strike Quadrante */
        #strikeQuadrante {
            text-transform: uppercase;
            background-color: #eef2ff; /* Viola chiaro */
            border-color: #818cf8;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-xl text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Misure Geologiche Interattive</h1>
        
        <!-- LAYOUT CAMPI DI INPUT (3 righe) -->
        <div class="mb-8 w-full max-w-md mx-auto">
            
            <!-- RIGA 1: Strike 3-cifre e Inclinazione -->
            <p class="text-sm font-semibold text-gray-500 mb-2">Metodo 1: Strike 3-cifre / Dip Angle</p>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <!-- Strike (Direzione del Piano) -->
                <div class="flex flex-col items-start">
                    <label for="strike3Cifre" class="text-sm font-medium text-gray-700 mb-1">Strike (Piano) [000-359°]</label>
                    <input type="text" id="strike3Cifre" value="090" maxlength="3"
                           class="w-full p-2 border border-gray-300 rounded-lg text-center font-mono text-lg bg-yellow-50 focus:ring-yellow-500 focus:border-yellow-500 transition-colors">
                    <div id="strike3CifreError" class="mt-1 text-sm text-red-600 h-5" style="visibility: hidden;">
                        Formato: 3 cifre (000-359)
                    </div>
                </div>

                <!-- Inclinazione (Dip Angle) - RIGA 1 -->
                <div class="flex flex-col items-start">
                    <label for="inclinazioneRiga1" class="text-sm font-medium text-gray-700 mb-1">Inclinazione (Angolo) [°]</label>
                    <input type="number" id="inclinazioneRiga1" value="45" min="0" max="90" step="1" 
                           class="w-full p-2 border border-gray-300 rounded-lg text-center font-mono text-lg focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    <div class="mt-1 h-5"></div>
                </div>
            </div>

            <!-- Divisore 1 -->
            <hr class="border-gray-300 my-4">

            <!-- RIGA 2: Dip Direction e Inclinazione -->
            <p class="text-sm font-semibold text-gray-500 mb-2">Metodo 2: Dip Direction / Dip Angle</p>
            <div class="grid grid-cols-2 gap-4 mb-4">
                
                <!-- Dip Direction (Direzione di Immersione) -->
                <div class="flex flex-col items-start">
                    <label for="dipDirezione" class="text-sm font-medium text-gray-700 mb-1">Dip Direction (Freccia) [000-359°]</label>
                    <input type="text" id="dipDirezione" value="180" maxlength="3"
                           class="w-full p-2 border border-gray-300 rounded-lg text-center font-mono text-lg bg-red-50 focus:ring-red-500 focus:border-red-500 transition-colors">
                    <div id="dipDirezioneError" class="mt-1 text-sm text-red-600 h-5" style="visibility: hidden;">
                        Formato: 3 cifre (000-359)
                    </div>
                </div>

                <!-- Inclinazione (Dip Angle) - RIGA 2 -->
                <div class="flex flex-col items-start">
                    <label for="inclinazioneRiga2" class="text-sm font-medium text-gray-700 mb-1">Inclinazione (Angolo) [°]</label>
                    <input type="number" id="inclinazioneRiga2" value="45" min="0" max="90" step="1" 
                           class="w-full p-2 border border-gray-300 rounded-lg text-center font-mono text-lg focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    <div class="mt-1 h-5"></div>
                </div>
            </div>

            <!-- Divisore 2 -->
            <hr class="border-gray-300 my-4">

            <!-- RIGA 3: Strike Quadrante e Inclinazione -->
            <p class="text-sm font-semibold text-gray-500 mb-2">Metodo 3: Strike Quadrante / Dip Angle</p>
            <div class="grid grid-cols-2 gap-4">
                
                <!-- Strike Quadrante (NxxE/SxxW) -->
                <div class="flex flex-col items-start">
                    <label for="strikeQuadrante" class="text-sm font-medium text-gray-700 mb-1">Strike Quadrante [NxxE, SxxW, etc.]</label>
                    <input type="text" id="strikeQuadrante" value="N90E" 
                           class="w-full p-2 border border-gray-400 rounded-lg text-center font-mono text-lg focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                    <div id="strikeQuadranteError" class="mt-1 text-sm text-red-600 h-5" style="visibility: hidden;">
                        Formato: NxxE o SxxW (xx=0-90)
                    </div>
                </div>

                <!-- Inclinazione (Dip Angle) - RIGA 3 -->
                <div class="flex flex-col items-start">
                    <label for="inclinazioneRiga3" class="text-sm font-medium text-gray-700 mb-1">Inclinazione (Angolo) [°]</label>
                    <input type="number" id="inclinazioneRiga3" value="45" min="0" max="90" step="1" 
                           class="w-full p-2 border border-gray-300 rounded-lg text-center font-mono text-lg focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    <div class="mt-1 h-5"></div>
                </div>
            </div>
        </div>

        <!-- Canvas per il disegno -->
        <canvas id="compassCanvas" width="450" height="450" class="rounded-full mx-auto"></canvas>

        <p class="mt-6 text-sm text-gray-600">
            La linea gialla è lo **Strike** (orientamento del piano) e la freccia rossa è il **Dip Direction** (direzione di immersione). Tutte le misurazioni sono sincronizzate.
        </p>
    </div>

    <script>
        // Funzione per convertire i gradi in radianti
        function toRadians(degrees) {
            return degrees * (Math.PI / 180);
        }
        
        // Funzione per disegnare una punta di freccia
        function drawArrowhead(ctx, x, y, angle, size) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            ctx.beginPath();
            ctx.moveTo(0, 0); // Punta della freccia
            ctx.lineTo(-size, size / 2);
            ctx.lineTo(-size, -size / 2);
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        }

        // --- VALIDAZIONE E CONVERSIONE ---

        /**
         * Validazione generica per i campi direzione 3-cifre (000-359).
         */
        function validateDirection3Cifre(value, errorId, updateUI = true) {
            const errorDiv = document.getElementById(errorId);
            const regex = /^\d{3}$/; 
            const numValue = parseInt(value, 10);
            const isValid = regex.test(value) && numValue >= 0 && numValue <= 359;

            if (updateUI) {
                if (isValid) {
                    errorDiv.style.visibility = 'hidden';
                } else {
                    errorDiv.style.visibility = 'visible';
                }
            }
            return isValid;
        }

        /**
         * Converte Strike 3-cifre (000-359) in Strike Quadrante (NxxE/SxxW)
         * @param {number} strike3Cifre - Valore Strike 3-cifre.
         * @returns {string} Strike Quadrante.
         */
        function convert3CifreToQuadrante(strike3Cifre) {
            if (strike3Cifre >= 0 && strike3Cifre <= 90) {
                return `N${strike3Cifre}E`;
            } else if (strike3Cifre > 90 && strike3Cifre <= 180) {
                return `S${180 - strike3Cifre}E`;
            } else if (strike3Cifre > 180 && strike3Cifre <= 270) {
                return `S${strike3Cifre - 180}W`;
            } else if (strike3Cifre > 270 && strike3Cifre < 360) {
                return `N${360 - strike3Cifre}W`;
            } else {
                return 'N/A'; // Non dovrebbe succedere
            }
        }

        /**
         * Converte Strike Quadrante (NxxE/SxxW) in Strike 3-cifre (000-359)
         * @param {string} quadrante - Valore Strike Quadrante (es: N30E).
         * @returns {number | null} Strike 3-cifre, o null se non valido.
         */
        function convertQuadranteTo3Cifre(quadrante) {
            // Rimuove spazi e converte in maiuscolo
            quadrante = quadrante.toUpperCase().trim();
            
            // Regex aggiornata per gestire meglio il formato
            const match = quadrante.match(/^([NS])(\d{1,2})([EW])$/);
            if (!match) return null;

            const start = match[1];
            const angle = parseInt(match[2], 10);
            const direction = match[3];

            if (angle < 0 || angle > 90) return null;

            if (start === 'N') {
                if (direction === 'E') return angle;
                if (direction === 'W') return 360 - angle;
            }
            if (start === 'S') {
                if (direction === 'E') return 180 - angle;
                if (direction === 'W') return 180 + angle;
            }
            return null;
        }

        /**
         * Validazione per Strike Quadrante (NxxE, SxxW, NxxW, SxxE)
         */
        function validateDirectionQuadrante(value, errorId, updateUI = true) {
            const errorDiv = document.getElementById(errorId);
            const regex = /^[NS]\d{1,2}[EW]$/i;
            const isValidFormat = regex.test(value);
            let isValidAngle = false;

            if (isValidFormat) {
                const angle = parseInt(value.substring(1, value.length - 1), 10);
                isValidAngle = angle >= 0 && angle <= 90;
            }

            const isValid = isValidFormat && isValidAngle;

            if (updateUI) {
                if (isValid) {
                    errorDiv.style.visibility = 'hidden';
                } else {
                    errorDiv.style.visibility = 'visible';
                }
            }
            return isValid;
        }
        
        // --- LOGICA DI SINCRONIZZAZIONE DEI CAMPI ---

        /**
         * Aggiorna tutti i campi di Strike/Dip Direction quando Strike 3-cifre cambia.
         * @param {number} strike3Cifre - Valore Strike in gradi (0-359).
         */
        function updateAllFromStrike3Cifre(strike3Cifre) {
            // Aggiorna Dip Direction (Dip Dir = Strike + 90)
            let dipDirection = (strike3Cifre + 90) % 360;
            document.getElementById('dipDirezione').value = dipDirection.toString().padStart(3, '0');
            
            // Aggiorna Strike Quadrante
            const strikeQuadrante = convert3CifreToQuadrante(strike3Cifre);
            document.getElementById('strikeQuadrante').value = strikeQuadrante;
            
            drawCompass();
        }

        /**
         * Aggiorna tutti i campi di Strike/Dip Direction quando Dip Direction cambia.
         * @param {number} dipDirectionValue - Valore Dip Direction in gradi (0-359).
         */
        function updateAllFromDipDirection(dipDirectionValue) {
            // Aggiorna Strike 3-cifre (Strike = Dip Dir - 90)
            let strike3Cifre = (dipDirectionValue - 90 + 360) % 360;
            document.getElementById('strike3Cifre').value = strike3Cifre.toString().padStart(3, '0');
            
            // Aggiorna Strike Quadrante
            const strikeQuadrante = convert3CifreToQuadrante(strike3Cifre);
            document.getElementById('strikeQuadrante').value = strikeQuadrante;

            drawCompass();
        }

        /**
         * Aggiorna tutti i campi di Strike/Dip Direction quando Strike Quadrante cambia.
         * @param {string} quadrante - Valore Strike Quadrante (es: N30E).
         */
        function updateAllFromStrikeQuadrante(quadrante) {
            const strike3Cifre = convertQuadranteTo3Cifre(quadrante);
            
            if (strike3Cifre !== null) {
                // Aggiorna Strike 3-cifre
                document.getElementById('strike3Cifre').value = strike3Cifre.toString().padStart(3, '0');
                
                // Aggiorna Dip Direction (Dip Dir = Strike + 90)
                let dipDirection = (strike3Cifre + 90) % 360;
                document.getElementById('dipDirezione').value = dipDirection.toString().padStart(3, '0');

                // Ridisegna la bussola con i nuovi valori
                drawCompass(); 
            } else {
                // Se il formato non è valido, nasconde l'errore e ridisegna con i valori validi attuali
                drawCompass(); 
            }
        }
        
        /**
         * Sincronizza il valore di Inclinazione tra tutti i campi e ridisegna.
         * @param {string} sourceId - ID del campo che ha innescato la modifica.
         */
        function syncInclinazione(sourceId) {
            const incl1 = document.getElementById('inclinazioneRiga1');
            const incl2 = document.getElementById('inclinazioneRiga2');
            const incl3 = document.getElementById('inclinazioneRiga3');
            
            // Ottiene il valore e lo assicura che sia compreso tra 0 e 90
            let value = Math.max(0, Math.min(90, parseFloat(document.getElementById(sourceId).value) || 0));
            
            // Sincronizza tutti i campi eccetto quello sorgente
            if (sourceId !== 'inclinazioneRiga1') incl1.value = value;
            if (sourceId !== 'inclinazioneRiga2') incl2.value = value;
            if (sourceId !== 'inclinazioneRiga3') incl3.value = value;

            drawCompass();
        }


        // --- FUNZIONE DI DISEGNO PRINCIPALE ---
        function drawCompass() {
            const canvas = document.getElementById('compassCanvas');
            if (!canvas.getContext) return;
            const ctx = canvas.getContext('2d');

            // --- LETTURA DEI VALORI ---
            const strikeInput = document.getElementById('strike3Cifre');
            const dipDirezioneInput = document.getElementById('dipDirezione');
            const inclinazioneInput = document.getElementById('inclinazioneRiga1'); // Usiamo il valore sincronizzato

            // Valori numerici validi
            let strike = 0;
            if (validateDirection3Cifre(strikeInput.value, 'strike3CifreError', false)) {
                 strike = parseInt(strikeInput.value, 10);
            }
            
            let dipDirection = 0;
            if (validateDirection3Cifre(dipDirezioneInput.value, 'dipDirezioneError', false)) {
                 dipDirection = parseInt(dipDirezioneInput.value, 10);
            }

            const inclinazione = parseFloat(inclinazioneInput.value) || 0;

            // Impostazioni del canvas
            const width = canvas.width;
            const height = canvas.height;
            const center = { x: width / 2, y: height / 2 };
            const radius = (width / 2) * 0.75; 
            const textClearance = (width / 2) * 0.05;
            const maxTextRadius = (width / 2) - textClearance; 
            
            const diameter = radius * 2;
            const lineLength = diameter * 0.60; 
            const distanceToCenter = lineLength / 2;
            const arrowHeadSize = 10; 

            // Pulisce il canvas
            ctx.clearRect(0, 0, width, height);

            // --- 1. Disegna la circonferenza principale e le tacche ---
            // Disegno del cerchio esterno
            ctx.beginPath();
            ctx.arc(center.x, center.y, radius, 0, 2 * Math.PI);
            ctx.strokeStyle = '#4b5563'; 
            ctx.lineWidth = 3;
            ctx.stroke();
            ctx.closePath();
            
            // Definisce e disegna le tacche e le etichette (Punti Cardinali)
            const markers = [
                { degree: 0, textLabel: 'N', color: '#ef4444', length: 15, size: '22px' },
                { degree: 90, textLabel: 'E', color: '#2563eb', length: 15, size: '22px' },
                { degree: 180, textLabel: 'S', color: '#22c55e', length: 15, size: '22px' },
                { degree: 270, textLabel: 'W', color: '#f59e0b', length: 15, size: '22px' },
                { degree: 45, textLabel: '45°', color: '#9ca3af', length: 8, size: '18px' },
                { degree: 135, textLabel: '135°', color: '#9ca3af', length: 8, size: '18px' },
                { degree: 225, textLabel: '225°', color: '#9ca3af', length: 8, size: '18px' },
                { degree: 315, textLabel: '315°', color: '#9ca3af', length: 8, size: '18px' },
            ];

            markers.forEach(marker => {
                const adjustedDegrees = marker.degree - 90; 
                const angleRad = toRadians(adjustedDegrees);
                
                const startX = center.x + radius * Math.cos(angleRad);
                const startY = center.y + radius * Math.sin(angleRad);
                const endRadius = radius - marker.length;
                const endX = center.x + endRadius * Math.cos(angleRad);
                const endY = center.y + endRadius * Math.sin(angleRad);

                // Disegna la linea della tacca
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(endX, endY);
                ctx.strokeStyle = marker.color;
                ctx.lineWidth = marker.length > 10 ? 3 : 2; 
                ctx.stroke();
                ctx.closePath();

                // Disegna l'etichetta 
                if (marker.textLabel) {
                    const desiredRadius = radius + 30; 
                    const textRadius = Math.min(desiredRadius, maxTextRadius);

                    const textX = center.x + textRadius * Math.cos(angleRad);
                    const textY = center.y + textRadius * Math.sin(angleRad);

                    ctx.fillStyle = marker.color;
                    ctx.font = `${marker.size} Inter`;
                    ctx.textAlign = 'center'; 
                    ctx.textBaseline = 'middle'; 
                    
                    ctx.fillText(marker.textLabel, textX, textY);
                }
            });


            // --- 2. Disegna STRIKE e DIP DIRECTION ---
            if (validateDirection3Cifre(dipDirezioneInput.value, 'dipDirezioneError', false)) {
                
                // A. Strike (Linea Gialla)
                const strikeAngleRad = toRadians(strike - 90); 
                
                const end1X = center.x + (-distanceToCenter) * Math.cos(strikeAngleRad);
                const end1Y = center.y + (-distanceToCenter) * Math.sin(strikeAngleRad);
                const end2X = center.x + distanceToCenter * Math.cos(strikeAngleRad);
                const end2Y = center.y + distanceToCenter * Math.sin(strikeAngleRad);

                // Disegna il segmento Strike (Giallo)
                ctx.beginPath();
                ctx.moveTo(end1X, end1Y); 
                ctx.lineTo(end2X, end2Y); 
                ctx.strokeStyle = '#f59e0b'; // Giallo/Arancio
                ctx.lineWidth = 4;
                ctx.stroke();
                ctx.closePath();
                
                // Disegna il cerchietto grigio chiaro sulla punta Strike (end2)
                ctx.beginPath();
                ctx.arc(end2X, end2Y, 5, 0, 2 * Math.PI); 
                ctx.fillStyle = '#9ca3af'; 
                ctx.fill();
                ctx.closePath();
                
                // B. Dip Direction (Freccia Rossa)
                const dipAngleRad = toRadians(dipDirection - 90); 
                
                const dipDirectionX = center.x + distanceToCenter * Math.cos(dipAngleRad);
                const dipDirectionY = center.y + distanceToCenter * Math.sin(dipAngleRad);

                // B1. Disegna la freccia dal centro al Dip Direction
                ctx.beginPath();
                ctx.moveTo(center.x, center.y); 
                ctx.lineTo(dipDirectionX, dipDirectionY); 
                ctx.strokeStyle = '#ef4444'; // Rosso vivo per la freccia
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.closePath();
                
                // B2. Disegna la punta della freccia (Dip Direction Marker)
                ctx.fillStyle = '#ef4444';
                drawArrowhead(ctx, dipDirectionX, dipDirectionY, dipAngleRad, arrowHeadSize); 
                
                // C. Aggiunge l'angolo di Inclinazione (Dip Angle) accanto alla freccia Dip Direction
                const textDipRadius = distanceToCenter + 20; 
                const textX = center.x + textDipRadius * Math.cos(dipAngleRad);
                const textY = center.y + textDipRadius * Math.sin(dipAngleRad);

                // Disegna il testo dell'inclinazione
                ctx.fillStyle = '#1e40af'; // Blu scuro
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`${inclinazione}°`, textX, textY);
            }
        }

        // --- GESTIONE DEGLI EVENT LISTENER ---
        function setupEventListeners() {
            const strike3CifreInput = document.getElementById('strike3Cifre');
            const dipDirezioneInput = document.getElementById('dipDirezione');
            const strikeQuadranteInput = document.getElementById('strikeQuadrante');
            
            const inclInputs = [
                document.getElementById('inclinazioneRiga1'),
                document.getElementById('inclinazioneRiga2'),
                document.getElementById('inclinazioneRiga3')
            ];

            // 1. Funzione helper per gestire l'input e la validazione/aggiornamento della Direzione
            const handleDirectionInput = (inputElement, errorId, updateFunction) => {
                const listener = function() {
                    let value = this.value.replace(/\D/g, ''); 
                    this.value = value.substring(0, 3); 
                    
                    if (validateDirection3Cifre(this.value, errorId, true)) {
                        updateFunction(parseInt(this.value, 10));
                    }
                };
                inputElement.addEventListener('input', listener);
                inputElement.addEventListener('change', listener);
            };

            // 1. Modifica Strike 3-cifre -> Aggiorna tutti
            handleDirectionInput(strike3CifreInput, 'strike3CifreError', updateAllFromStrike3Cifre);

            // 2. Modifica del Dip Direction -> Aggiorna tutti
            handleDirectionInput(dipDirezioneInput, 'dipDirezioneError', updateAllFromDipDirection);

            // 3. Modifica Strike Quadrante -> Aggiorna tutti (LOGICA CORRETTA)
            strikeQuadranteInput.addEventListener('input', function() {
                // Pulisce l'input, permettendo solo lettere N, S, E, W e numeri
                this.value = this.value.toUpperCase().replace(/[^NSEW0-9]/g, '');
                
                if (validateDirectionQuadrante(this.value, 'strikeQuadranteError', true)) {
                    updateAllFromStrikeQuadrante(this.value);
                } else {
                    // Se l'input non è valido, mostra l'errore e ridisegna con i valori attuali validi
                    drawCompass();
                }
            });
            strikeQuadranteInput.addEventListener('change', function() {
                if (validateDirectionQuadrante(this.value, 'strikeQuadranteError', false)) {
                    updateAllFromStrikeQuadrante(this.value);
                }
            });


            // 4. Modifica dell'Inclinazione (Dip Angle) - Sincronizzazione e ridisegno
            inclInputs.forEach(input => {
                input.addEventListener('input', () => syncInclinazione(input.id));
                input.addEventListener('change', () => syncInclinazione(input.id));
            });
        }

        // Avvia il disegno e configura gli eventi
        window.onload = function() {
            // Inizializzazione per coerenza
            const initialStrike3Cifre = '090';
            document.getElementById('strike3Cifre').value = initialStrike3Cifre; 
            
            // Imposta Dip Direction (180) e Strike Quadrante (N90E) inizialmente
            updateAllFromStrike3Cifre(parseInt(initialStrike3Cifre, 10));
            
            setupEventListeners();
        };
    </script>

</body>
</html>
